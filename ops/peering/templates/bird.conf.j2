# BIRD v2 Configuration for AEGIS Edge Node
# Generated by: {{ generated_by }}
# Generated at: {{ generated_at }}
# Node: {{ node.node_name }}
# Location: {{ node.location | default('Unknown') }}
#
# DO NOT EDIT MANUALLY - This file is auto-generated
# Edit the source YAML files in data/ and regenerate

# ============================================================================
# Router Identity
# ============================================================================

router id {{ node.router_id }};

# Enable logging
log syslog all;
{% if global.debug | default(false) %}
debug protocols { states, routes, filters, interfaces, events };
{% else %}
debug protocols { states };
{% endif %}

# ============================================================================
# Constants
# ============================================================================

define AEGIS_ANYCAST_V4 = {{ global.anycast_v4 }};
define AEGIS_ANYCAST_V6 = {{ global.anycast_v6 }};
define AEGIS_AS = {{ global.as_number }};

# ============================================================================
# RPKI Configuration (Route Origin Validation)
# ============================================================================

{% if global.rpki.enabled | default(true) %}
roa4 table rpki4;
roa6 table rpki6;

protocol rpki rpki_validator {
    roa4 { table rpki4; };
    roa6 { table rpki6; };

    # Connect to Routinator instance via RTR protocol
    remote "{{ global.rpki.validator_host | default('127.0.0.1') }}" port {{ global.rpki.validator_port | default(3323) }};

    # Retry configuration
    retry keep 90;
    refresh keep 900;
    expire keep 172800;
}
{% endif %}

# ============================================================================
# Routing Tables
# ============================================================================

ipv4 table master4;
ipv6 table master6;

# ============================================================================
# Kernel Protocol (sync with OS routing table)
# ============================================================================

protocol kernel kernel4 {
    ipv4 {
        import none;
        export all;
    };
    merge paths on;
}

protocol kernel kernel6 {
    ipv6 {
        import none;
        export all;
    };
    merge paths on;
}

# ============================================================================
# Device Protocol (monitor network interfaces)
# ============================================================================

protocol device {
    scan time 10;
}

# ============================================================================
# Direct Protocol (directly connected routes)
# ============================================================================

protocol direct {
    ipv4;
    ipv6;
    interface "{{ node.interfaces.loopback | default('lo') }}";
}

# ============================================================================
# Static Routes (Anycast Announcement)
# ============================================================================

protocol static static4 {
    ipv4;
    route AEGIS_ANYCAST_V4 blackhole;
}

protocol static static6 {
    ipv6;
    route AEGIS_ANYCAST_V6 blackhole;
}

# ============================================================================
# Filter Functions
# ============================================================================

{% include 'filters.conf.j2' %}

# ============================================================================
# BGP Protocol Template
# ============================================================================

template bgp bgp_peer {
    local as AEGIS_AS;
    graceful restart on;

    # BGP timers
    hold time {{ global.bgp_timers.hold | default(90) }};
    keepalive time {{ global.bgp_timers.keepalive | default(30) }};
    connect retry time {{ global.bgp_timers.connect_retry | default(30) }};

    # Path attributes
    next hop self;

    # Error handling
    error wait time 60, 300;
    error forget time 300;

    # Route limits
    receive limit {{ global.route_limits.max_import | default(10000) }} action restart;

    ipv4 {
        import filter bgp_import_v4;
        export filter bgp_export_v4;
    };

    ipv6 {
        import filter bgp_import_v6;
        export filter bgp_export_v6;
    };
}

# ============================================================================
# BGP Peers
# ============================================================================

{% for peer in peers %}
{% include 'peer.conf.j2' %}

{% endfor %}

# ============================================================================
# BFD (Bidirectional Forwarding Detection)
# ============================================================================

{% if global.bfd.enabled | default(true) %}
protocol bfd {
    interface "*" {
        min rx interval {{ global.bfd.min_rx_interval | default(100) }} ms;
        min tx interval {{ global.bfd.min_tx_interval | default(100) }} ms;
        idle tx interval 300 ms;
        multiplier {{ global.bfd.multiplier | default(3) }};
    };
}
{% endif %}

# ============================================================================
# Health Check Integration
# ============================================================================

# Health check script should use birdc to add/remove routes:
#   birdc enable static4    # Announce anycast when healthy
#   birdc disable static4   # Withdraw anycast when unhealthy
#
# See: ops/bgp/check-health.sh

# End of configuration for {{ node.node_name }}
