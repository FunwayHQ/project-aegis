# BIRD v2 Configuration for AEGIS Edge Node
# Generated by: AEGIS Peering Manager
# Generated at: 2025-12-28T16:38:21.935062
# Node: edge-us-east
# Location: US East (Ashburn, Virginia)
#
# DO NOT EDIT MANUALLY - This file is auto-generated
# Edit the source YAML files in data/ and regenerate

# ============================================================================
# Router Identity
# ============================================================================

router id 10.0.1.1;

# Enable logging
log syslog all;
debug protocols { states };

# ============================================================================
# Constants
# ============================================================================

define AEGIS_ANYCAST_V4 = 203.0.113.0/24;
define AEGIS_ANYCAST_V6 = 2001:db8::/32;
define AEGIS_AS = 64512;

# ============================================================================
# RPKI Configuration (Route Origin Validation)
# ============================================================================

roa4 table rpki4;
roa6 table rpki6;

protocol rpki rpki_validator {
    roa4 { table rpki4; };
    roa6 { table rpki6; };

    # Connect to Routinator instance via RTR protocol
    remote "127.0.0.1" port 3323;

    # Retry configuration
    retry keep 90;
    refresh keep 900;
    expire keep 172800;
}

# ============================================================================
# Routing Tables
# ============================================================================

ipv4 table master4;
ipv6 table master6;

# ============================================================================
# Kernel Protocol (sync with OS routing table)
# ============================================================================

protocol kernel kernel4 {
    ipv4 {
        import none;
        export all;
    };
    merge paths on;
}

protocol kernel kernel6 {
    ipv6 {
        import none;
        export all;
    };
    merge paths on;
}

# ============================================================================
# Device Protocol (monitor network interfaces)
# ============================================================================

protocol device {
    scan time 10;
}

# ============================================================================
# Direct Protocol (directly connected routes)
# ============================================================================

protocol direct {
    ipv4;
    ipv6;
    interface "lo";
}

# ============================================================================
# Static Routes (Anycast Announcement)
# ============================================================================

protocol static static4 {
    ipv4;
    route AEGIS_ANYCAST_V4 blackhole;
}

protocol static static6 {
    ipv6;
    route AEGIS_ANYCAST_V6 blackhole;
}

# ============================================================================
# Filter Functions
# ============================================================================


# RPKI validation function (IPv4)
function rpki_validate_v4(int asn) {
    if (roa_check(rpki4, net, asn) = ROA_INVALID) then {
        print "ROA INVALID: ", net, " AS", asn;
        return false;
    }
    return true;
}

# RPKI validation function (IPv6)
function rpki_validate_v6(int asn) {
    if (roa_check(rpki6, net, asn) = ROA_INVALID) then {
        print "ROA INVALID: ", net, " AS", asn;
        return false;
    }
    return true;
}

# IPv4 import filter
filter bgp_import_v4 {
    # Reject bogon prefixes (RFC 5737, RFC 1918, etc.)
    if net ~ [
        0.0.0.0/8+,          # RFC 1122: This network
        10.0.0.0/8+,         # RFC 1918: Private-use
        100.64.0.0/10+,      # RFC 6598: Shared address space (CGNAT)
        127.0.0.0/8+,        # RFC 1122: Loopback
        169.254.0.0/16+,     # RFC 3927: Link-local
        172.16.0.0/12+,      # RFC 1918: Private-use
        192.0.0.0/24+,       # RFC 6890: IETF Protocol Assignments
        192.0.2.0/24+,       # RFC 5737: Documentation (TEST-NET-1)
        192.168.0.0/16+,     # RFC 1918: Private-use
        198.18.0.0/15+,      # RFC 2544: Benchmarking
        198.51.100.0/24+,    # RFC 5737: Documentation (TEST-NET-2)
        203.0.113.0/24+,     # RFC 5737: Documentation (TEST-NET-3)
        224.0.0.0/4+,        # RFC 5771: Multicast
        240.0.0.0/4+         # RFC 6890: Reserved
    ] then {
        print "Rejected bogon prefix: ", net;
        reject;
    }

    # Validate route origin with RPKI
    if !rpki_validate_v4(bgp_path.last) then {
        reject;
    }

    # Reject routes with private AS numbers in path
    if bgp_path ~ [64512..65534, 4200000000..4294967294] then {
        print "Rejected route with private ASN: ", net;
        reject;
    }

    # Reject too specific prefixes (< /24)
    if net.len > 24 then {
        print "Rejected too specific prefix: ", net;
        reject;
    }

    accept;
}

# IPv6 import filter
filter bgp_import_v6 {
    # Reject bogon IPv6 prefixes
    if net ~ [
        ::/0,                # Default route
        ::/128,              # Unspecified
        ::1/128,             # Loopback
        ::ffff:0.0.0.0/96,   # IPv4-mapped
        ::/96,               # IPv4-compatible (deprecated)
        100::/64,            # Discard-only (RFC 6666)
        2001:2::/48,         # Benchmarking
        2001:10::/28,        # ORCHID
        2001:db8::/32,       # Documentation
        fe80::/10,           # Link-local
        fc00::/7,            # Unique local addresses
        ff00::/8             # Multicast
    ] then {
        print "Rejected bogon IPv6 prefix: ", net;
        reject;
    }

    # RPKI validation
    if !rpki_validate_v6(bgp_path.last) then {
        reject;
    }

    # Reject routes with private AS numbers in path
    if bgp_path ~ [64512..65534, 4200000000..4294967294] then {
        print "Rejected route with private ASN in path: ", net;
        reject;
    }

    # Reject too specific prefixes (< /48)
    if net.len > 48 then {
        print "Rejected too specific IPv6 prefix: ", net;
        reject;
    }

    accept;
}

# IPv4 export filter
filter bgp_export_v4 {
    # Only announce our anycast prefix
    if net = AEGIS_ANYCAST_V4 then {
        # Add BGP communities
        bgp_community.add((64512:1));
        accept;
    }
    reject;
}

# IPv6 export filter
filter bgp_export_v6 {
    # Only announce our anycast prefix
    if net = AEGIS_ANYCAST_V6 then {
        bgp_community.add((64512:1));
        accept;
    }
    reject;
}
# ============================================================================
# BGP Protocol Template
# ============================================================================

template bgp bgp_peer {
    local as AEGIS_AS;
    graceful restart on;

    # BGP timers
    hold time 90;
    keepalive time 30;
    connect retry time 30;

    # Path attributes
    next hop self;

    # Error handling
    error wait time 60, 300;
    error forget time 300;

    # Route limits
    receive limit 10000 action restart;

    ipv4 {
        import filter bgp_import_v4;
        export filter bgp_export_v4;
    };

    ipv6 {
        import filter bgp_import_v6;
        export filter bgp_export_v6;
    };
}

# ============================================================================
# BGP Peers
# ============================================================================


# Peer: transit1 (transit)
# Primary Transit Provider
# Contact: noc@transit1.example.com
# Bandwidth: 10 Gbps
protocol bgp transit1 from bgp_peer {
    description "Primary Transit Provider";
    neighbor 192.0.2.1 as 65001;
    password "CHANGE_THIS_SECURE_PASSWORD_1";
    multihop 2;
    default bgp_local_pref 150;
    bfd on;
    ipv4 {
        import limit 100000 action restart;
    };
}

# Peer: ixp1 (ixp)
# DE-CIX New York Route Server
# Contact: noc@de-cix.net
# Bandwidth: N/A
protocol bgp ixp1 from bgp_peer {
    description "DE-CIX New York Route Server";
    neighbor 198.51.100.1 as 65002;
    default bgp_local_pref 200;
    rs client;
    ipv4 {
        import limit 500000 action restart;
    };
}

# Peer: private1 (private)
# Large Content Provider - Private Peering
# Contact: peering@contentprovider.example.com
# Bandwidth: 100 Gbps
protocol bgp private1 from bgp_peer {
    description "Large Content Provider - Private Peering";
    neighbor 203.0.113.1 as 65003;
    password "CHANGE_THIS_SECURE_PASSWORD_2";
    default bgp_local_pref 400;
    bfd on;
    ipv4 {
        import limit 10000 action restart;
    };
}

# ============================================================================
# BFD (Bidirectional Forwarding Detection)
# ============================================================================

protocol bfd {
    interface "*" {
        min rx interval 100 ms;
        min tx interval 100 ms;
        idle tx interval 300 ms;
        multiplier 3;
    };
}

# ============================================================================
# Health Check Integration
# ============================================================================

# Health check script should use birdc to add/remove routes:
#   birdc enable static4    # Announce anycast when healthy
#   birdc disable static4   # Withdraw anycast when unhealthy
#
# See: ops/bgp/check-health.sh

# End of configuration for edge-us-east